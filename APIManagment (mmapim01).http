# $token=$(az account get-access-token --query accessToken --output tsv)

@Token             = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyIsImtpZCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9kZGRiMjY2MS03OTA4LTRmMjctYTY3Yy1kMWI0ODRkZjYyNWIvIiwiaWF0IjoxNzE5MTgzMzE3LCJuYmYiOjE3MTkxODMzMTcsImV4cCI6MTcxOTE4NzQ0NSwiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhYQUFBQWhlYU5IK0pxS3pZL0Rnb3JPT0NpZi9rZjJSWU1YaVU5Ym9iSWdkUXljbGNDZFRrRk9iYXBuVHd0TkFSL3p2NFQyNkZDdmx6Sno3M0VCM1dDL3lLTSt5bDFGekZMaFRrZU95UHhUK0VLMWU0PSIsImFtciI6WyJwd2QiLCJtZmEiXSwiYXBwaWQiOiJiNjc3YzI5MC1jZjRiLTRhOGUtYTYwZS05MWJhNjUwYTRhYmUiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6Ik1pbmVsbGEiLCJnaXZlbl9uYW1lIjoiTWF1cm8iLCJncm91cHMiOlsiNjA3ODFjMGYtZTlkYi00YWVlLThiOTctODE4ZmM2ZmJjODQ2IiwiYmMyOGM4ODItYWI5NC00ODk5LTliNGEtY2U0NjNkZGYxOWU3IiwiMTk2YTA5ZGUtZTIyNi00MTMwLWE3NjctZTMzM2U5ODQzOTRlIiwiOWNjNmE5MDAtZTFlNi00OWFkLTlhNjEtNWYxNjBkOTQxY2U1IiwiNjlkNmYxZTUtNGI1MC00N2Q0LTkxMDEtMGFiOGRmYzg1ZWIxIl0sImlkdHlwIjoidXNlciIsImlwYWRkciI6IjkzLjU2LjEwNC4yNDkiLCJuYW1lIjoiTWF1cm8gTWluZWxsYSIsIm9pZCI6IjZjZTFhYTVhLTgwY2QtNDBhNi1hZmFiLWU1NGFjNTM4MDQ5ZiIsInB1aWQiOiIxMDAzMjAwMjM0MDBBQjI5IiwicmgiOiIwLkFWa0FZU2JiM1FoNUowLW1mTkcwaE45aVcwWklmM2tBdXRkUHVrUGF3ZmoyTUJPZEFJWS4iLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJrNUljQlFPVE5rdUNwU1NEVHo4aGZ5TEpWdG96N1JYdlZfN1I1MnRpZjkwIiwidGlkIjoiZGRkYjI2NjEtNzkwOC00ZjI3LWE2N2MtZDFiNDg0ZGY2MjViIiwidW5pcXVlX25hbWUiOiJtYXVyby5taW5lbGxhQG1uZ2Vudjc4OTkxMS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJtYXVyby5taW5lbGxhQG1uZ2Vudjc4OTkxMS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJTLVJNa1V1eV9FVzhBMnpuZVl0bUFBIiwidmVyIjoiMS4wIiwid2lkcyI6WyIxMTY0ODU5Ny05MjZjLTRjZjMtOWMzNi1iY2ViYjBiYThkY2MiLCJhOWVhODk5Ni0xMjJmLTRjNzQtOTUyMC04ZWRjZDE5MjgyNmMiLCI2MmU5MDM5NC02OWY1LTQyMzctOTE5MC0wMTIxNzcxNDVlMTAiLCJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX2lkcmVsIjoiMSAyMCIsInhtc190Y2R0IjoxNjYyNTgwMTQyfQ.Nm9vKCJsoOekls1hc75bGfuc2hECpR0VPbwTYWezBkBFnSs3el9DdgOl-WZR2gA1iCYEeeHKT3EinXx_Ib10WVYzhMmSdbiu5iuJi0zIe2JjhViggGfMxZjvxGxeVernMNZt1wqvBt7AF_oEwI0KH5pzA0fIJmvmCDQ--vTtH0BSJksf2yFDQOrPJuQW4MZAetZV9rV_FKcomNWNnARRRtGrYg-A6J5h9LNGgWMqFu96QiKhV-jHDsWE55nnV4AnEFj3nAWtVY3ZPfo9ZCvAd_qABbGT48FUyza2WI79Eny4YxzMxKiFDapZhzssNAB_nnM1be82Qmgj-LwUZh6_fw

@subscriptionId    = 43273dfb-d66b-4034-9103-d0671032d4fc
@resourceGroupName = mauromi-ml-wrkgp01
@apimName          = mmapim01
@backendPool       = backend-openai-pool
@backendBal1       = backend-openai-main
@backendBal2       = backend-openai-fallback

@apimApiVersion    = 2023-09-01-preview

# Backend Retrieval using GET
@backendToRetrieve={{backendBal1}}
GET https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendToRetrieve}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}

###

# Backend Pool Creation or Update using PUT
PUT https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendPool}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "type": "Microsoft.ApiManagement/service/backends",
  "name": "{{backendPool}}",
  "properties": {
    "description": "{{backendPool}}",
    "type": "Pool",
    "pool": {
      "services": [
        {
          "id": "/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal1}}",
          "priority":1
        },
        {
          "id": "/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal2}}",
          "priority":2,
        }
      ]
    }
  }
}

### Backend Main - GET
GET https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal1}}?api-version=2022-08-01
Authorization: Bearer {{Token}}

###

# Backend Pool - Main
PUT https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal1}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}
Content-Type: application/json

  {
    "properties": {
      "description": "backend-openai-main",
      "url": "https://mmopenaisec.openai.azure.com/openai",
      "protocol": "http",
      "credentials": {
        "query": {
            "api-version": [
            "{{opeanai-api-version}}"
            ]
        },      
        "header": {
            "Content-Type": [
            "{{Content-Type}}"
            ],
            "api-key": [
            "{{openai-backend-key}}"
            ]
        }
      },
      "tls": {
        "validateCertificateChain": true,
        "validateCertificateName": true
      },
      "circuitBreaker": {
        "rules": [
          {
            "failureCondition": {
              "count": "1",
              "interval": "PT10S" ,
              "statusCodeRanges": [
                {
                  "min": "429",
                  "max": "429"
                }
              ]
            },
            "name": "myBreakerRule",
            "tripDuration": "PT1H",
            "acceptRetryAfter": "true"
          }
        ]
      }
    }
  }
}