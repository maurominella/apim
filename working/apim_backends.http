# $token=$(az account get-access-token --query accessToken --output tsv)

@Token               = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyIsImtpZCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9kZGRiMjY2MS03OTA4LTRmMjctYTY3Yy1kMWI0ODRkZjYyNWIvIiwiaWF0IjoxNzE5NTUzODkyLCJuYmYiOjE3MTk1NTM4OTIsImV4cCI6MTcxOTU1OTQyOSwiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhYQUFBQXRFYTNzOGQwTEJpc09QcEFIWnNIYTJwNGdjOCtNZ29leWhHemliVGFxOEd0ZDg2cmp4OHdqYUNhQkdqcGd1VVNzY1dKd2dGYW5OaXMvaENBRjB6MFRMSmFxeDJYRFFEVFlzRkFwNDFmdkk0PSIsImFtciI6WyJwd2QiLCJtZmEiXSwiYXBwaWQiOiIwNGIwNzc5NS04ZGRiLTQ2MWEtYmJlZS0wMmY5ZTFiZjdiNDYiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6Ik1pbmVsbGEiLCJnaXZlbl9uYW1lIjoiTWF1cm8iLCJncm91cHMiOlsiNjA3ODFjMGYtZTlkYi00YWVlLThiOTctODE4ZmM2ZmJjODQ2IiwiYmMyOGM4ODItYWI5NC00ODk5LTliNGEtY2U0NjNkZGYxOWU3IiwiMTk2YTA5ZGUtZTIyNi00MTMwLWE3NjctZTMzM2U5ODQzOTRlIiwiOWNjNmE5MDAtZTFlNi00OWFkLTlhNjEtNWYxNjBkOTQxY2U1IiwiNjlkNmYxZTUtNGI1MC00N2Q0LTkxMDEtMGFiOGRmYzg1ZWIxIl0sImlkdHlwIjoidXNlciIsImlwYWRkciI6IjJhMDE6MTEwOjgwMTI6MTAxMzo3MjI3OjYzYjA6Yzk5NDo2ZGFhIiwibmFtZSI6Ik1hdXJvIE1pbmVsbGEiLCJvaWQiOiI2Y2UxYWE1YS04MGNkLTQwYTYtYWZhYi1lNTRhYzUzODA0OWYiLCJwdWlkIjoiMTAwMzIwMDIzNDAwQUIyOSIsInJoIjoiMC5BVmtBWVNiYjNRaDVKMC1tZk5HMGhOOWlXMFpJZjNrQXV0ZFB1a1Bhd2ZqMk1CT2RBSVkuIiwic2NwIjoidXNlcl9pbXBlcnNvbmF0aW9uIiwic3ViIjoiazVJY0JRT1ROa3VDcFNTRFR6OGhmeUxKVnRvejdSWHZWXzdSNTJ0aWY5MCIsInRpZCI6ImRkZGIyNjYxLTc5MDgtNGYyNy1hNjdjLWQxYjQ4NGRmNjI1YiIsInVuaXF1ZV9uYW1lIjoibWF1cm8ubWluZWxsYUBtbmdlbnY3ODk5MTEub25taWNyb3NvZnQuY29tIiwidXBuIjoibWF1cm8ubWluZWxsYUBtbmdlbnY3ODk5MTEub25taWNyb3NvZnQuY29tIiwidXRpIjoibklHSWcxN0pJVVdwdjFwM2JPTU1BUSIsInZlciI6IjEuMCIsIndpZHMiOlsiMTE2NDg1OTctOTI2Yy00Y2YzLTljMzYtYmNlYmIwYmE4ZGNjIiwiYTllYTg5OTYtMTIyZi00Yzc0LTk1MjAtOGVkY2QxOTI4MjZjIiwiNjJlOTAzOTQtNjlmNS00MjM3LTkxOTAtMDEyMTc3MTQ1ZTEwIiwiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc19pZHJlbCI6IjEgMTIiLCJ4bXNfdGNkdCI6MTY2MjU4MDE0Mn0.nfelE_YzeiOuDHxdGSkBwSn172HSa_lSjmih1iVFS3sM_9baCdyd4p9yVkDUbmqNEO64imPX9HEXN2Dr1S4Rd7m969XNvEPQmvZeh9rw0vk1x39NooZepmTzZgQGyNrOw6S-ail4CfYWnP45iGLMrUrDVedawiEGEWZ5iejgESXnHPNkKbao9pMMGrexNE4CqEKy4Vd5EZBPffauZlia5a_vqU99xtLIl9smL76epaZAkY76N6FAtzT9Dp3P7vSY-UprucvXnqJH5yMFM-xd6ltsj76pfvC9LQPHPTSNly_wh27YflDUcikW1zk2hpQSKkI9vb58q8_J88x7e7QO9g

@subscription-id     = 43273dfb-d66b-4034-9103-d0671032d4fc
@resource-group-name = mmcognitivegrp

@apim-name           = mmapim01 
@apim-api-version    = 2023-09-01-preview

@backend-openai-fallback-name = backend-openai-main-mmopenaiscus
@backend-openai-fallback-url  = https://mmopenaiscus.openai.azure.com/openai

@backend-openai-main-name = backend-openai-main-mmopenaisec
@backend-openai-main-url  = https://mmopenaisec.openai.azure.com/openai

@backend-openai-pool-name = backend-openai-pool



# Backend - Fallback (no restrictions)
PUT https://management.azure.com/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-fallback-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backend-openai-fallback-name}}",
    "description": "{{backend-openai-fallback-name}}",
    "url": "{{backend-openai-fallback-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    }
  }
}


###
# Backend - Main with Circuit Breaker
PUT https://management.azure.com/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-main-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backend-openai-main-name}}",
    "description": "{{backend-openai-main-name}}",
    "url": "{{backend-openai-main-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    },
    "circuitBreaker": {
      "rules": [
        {
          "name": "myBreakerRule",
          "tripDuration": "PT1M",
          "acceptRetryAfter": "false",
          "failureCondition": {
            "count": "3",
            "interval": "PT10S",
            "statusCodeRanges": [
              {
                "min": "429",
                "max": "429"
              }
            ]
          }
        }
      ]
    }
  }
}

###

# Backend Pool Creation or Update using PUT
PUT https://management.azure.com/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-pool-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "type": "Microsoft.ApiManagement/service/backends",
  "name": "{{backend-openai-pool-name}}",
  "properties": {
    "description": "{{backend-openai-pool-name}}",
    "type": "Pool",
    "pool": {
      "services": [
        {
          "id": "/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-main-name}}",
          "priority":1
        },
        {
          "id": "/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-fallback-name}}",
          "priority":2
        }
      ]
    }
  }
}

###

# Backend Retrieval using GET for backend-openai-main-name, backend-openai-fallback-name and backend-openai-pool-name
@backendToRetrieve={{backend-openai-main-name}}
GET https://management.azure.com/subscriptions/{{subscription-id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backendToRetrieve}}?api-version={{apim-api-version}}
Authorization: Bearer {{Token}}

###
