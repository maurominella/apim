# $token=$(az account get-access-token --query accessToken --output tsv)

@Token             = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyIsImtpZCI6Ik1HTHFqOThWTkxvWGFGZnBKQ0JwZ0I0SmFLcyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC9kZGRiMjY2MS03OTA4LTRmMjctYTY3Yy1kMWI0ODRkZjYyNWIvIiwiaWF0IjoxNzE5NDQ0NDIyLCJuYmYiOjE3MTk0NDQ0MjIsImV4cCI6MTcxOTQ0OTI2NywiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhYQUFBQXpsbUtNNlVqeEc3Y3d6ODN2WFZSL3N1cUdqR2tteGhNUFVWMzZNMjJ0Q0xaREJaUTQ5aTYrK1JDeWgwaTd3YzBlYjl0RW52TEo0c0xxZk4zSnpBMzZhQ29EeWxNSXRDN2x5SjRnaGRudDlNPSIsImFtciI6WyJwd2QiLCJtZmEiXSwiYXBwaWQiOiIwNGIwNzc5NS04ZGRiLTQ2MWEtYmJlZS0wMmY5ZTFiZjdiNDYiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6Ik1pbmVsbGEiLCJnaXZlbl9uYW1lIjoiTWF1cm8iLCJncm91cHMiOlsiNjA3ODFjMGYtZTlkYi00YWVlLThiOTctODE4ZmM2ZmJjODQ2IiwiYmMyOGM4ODItYWI5NC00ODk5LTliNGEtY2U0NjNkZGYxOWU3IiwiMTk2YTA5ZGUtZTIyNi00MTMwLWE3NjctZTMzM2U5ODQzOTRlIiwiOWNjNmE5MDAtZTFlNi00OWFkLTlhNjEtNWYxNjBkOTQxY2U1IiwiNjlkNmYxZTUtNGI1MC00N2Q0LTkxMDEtMGFiOGRmYzg1ZWIxIl0sImlkdHlwIjoidXNlciIsImlwYWRkciI6IjkzLjU2LjEwNC4yNDkiLCJuYW1lIjoiTWF1cm8gTWluZWxsYSIsIm9pZCI6IjZjZTFhYTVhLTgwY2QtNDBhNi1hZmFiLWU1NGFjNTM4MDQ5ZiIsInB1aWQiOiIxMDAzMjAwMjM0MDBBQjI5IiwicmgiOiIwLkFWa0FZU2JiM1FoNUowLW1mTkcwaE45aVcwWklmM2tBdXRkUHVrUGF3ZmoyTUJPZEFJWS4iLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzdWIiOiJrNUljQlFPVE5rdUNwU1NEVHo4aGZ5TEpWdG96N1JYdlZfN1I1MnRpZjkwIiwidGlkIjoiZGRkYjI2NjEtNzkwOC00ZjI3LWE2N2MtZDFiNDg0ZGY2MjViIiwidW5pcXVlX25hbWUiOiJtYXVyby5taW5lbGxhQG1uZ2Vudjc4OTkxMS5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJtYXVyby5taW5lbGxhQG1uZ2Vudjc4OTkxMS5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJZMnpnMHpRcFEwMjNaLVdfblFhekFBIiwidmVyIjoiMS4wIiwid2lkcyI6WyIxMTY0ODU5Ny05MjZjLTRjZjMtOWMzNi1iY2ViYjBiYThkY2MiLCJhOWVhODk5Ni0xMjJmLTRjNzQtOTUyMC04ZWRjZDE5MjgyNmMiLCI2MmU5MDM5NC02OWY1LTQyMzctOTE5MC0wMTIxNzcxNDVlMTAiLCJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX2NhZSI6IjEiLCJ4bXNfY2MiOlsiQ1AxIl0sInhtc19maWx0ZXJfaW5kZXgiOlsiODkiXSwieG1zX2lkcmVsIjoiMSAyMCIsInhtc19yZCI6IjAuNDJMbFlCUmlqQVFBIiwieG1zX3NzbSI6IjEiLCJ4bXNfdGNkdCI6MTY2MjU4MDE0Mn0.Noa5NWf8DjyWQeUt3Qgm5MkcthktHr5S-TAL-kH-lbnuFrMpIgRxuz_myx98wkAcEML1Avb8H_pzE93l_FPwjA3JWxs0EZIl6JOW4kN7ZtXx8nEnbe2E9IrOOzdoxYs8Mzp6sE5JswI9XQFI0jOeFLipDMNfLm7HZGvv9MPRHxd1LlXdE1QcW_QNhapCIIcisiwRPQHnwqIbZO1ZXo3Wk-ZGdON1GYc3OIVrPTmo5H7cRtQNgP9RVjoMf7GLEXTDk90k5nPL_h4QXWcBejZ5UCntp9mOJpJg0WoUm6X8v406MALs5_w4ahYakeT2iVPb2umDcYjqAwfDV_HZOybAOg

@subscriptionId    = 43273dfb-d66b-4034-9103-d0671032d4fc
@resourceGroupName = mauromi-ml-wrkgp01
@apimName          = mmapim01
@backendPool       = backend-openai-pool

@backendBal1       = backend-openai-main
@backendBal1-url   = https://mmopenaisec.openai.azure.com/openai

@backendBal2       = backend-openai-fallback
@backendBal2-url   = https://mmopenaiscus.openai.azure.com/openai

@apimApiVersion    = 2023-09-01-preview

# Backend Retrieval using GET
@backendToRetrieve={{backendPool}}
GET https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendToRetrieve}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}

###

# Backend - Main with Circuit Breaker
PUT https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal1}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backendBal1}}",
    "description": "{{backendBal1-url}}",
    "url": "{{backendBal1-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    },
    "circuitBreaker": {
      "rules": [
        {
          "name": "myBreakerRule",
          "tripDuration": "PT60S",
          "acceptRetryAfter": "false",
          "failureCondition": {
            "count": "3",
            "interval": "PT10S" ,
            "statusCodeRanges": [
              {
                "min": "429",
                "max": "429"
              }
            ]
          }
        }
      ]
    }
  }
}

###

# Backend - Fallback (no restrictions)
PUT https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal2}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backendBal2}}",
    "description": "{{backendBal2-url}}",
    "url": "{{backendBal2-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    }
  }
}

###

# Backend Pool Creation or Update using PUT
PUT https://management.azure.com/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendPool}}?api-version={{apimApiVersion}}
Authorization: Bearer {{Token}}
Content-Type: application/json

{
  "type": "Microsoft.ApiManagement/service/backends",
  "name": "{{backendPool}}",
  "properties": {
    "description": "{{backendPool}}",
    "type": "Pool",
    "pool": {
      "services": [
        {
          "id": "/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal1}}",
          "priority":1
        },
        {
          "id": "/subscriptions/{{subscriptionId}}/resourceGroups/{{resourceGroupName}}/providers/Microsoft.ApiManagement/service/{{apimName}}/backends/{{backendBal2}}",
          "priority":2
        }
      ]
    }
  }
}

###