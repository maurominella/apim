# $token=$(az account get-access-token --query accessToken --output tsv)
@env                 = mauromiapim01

@token               = eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IllUY2VPNUlKeXlxUjZqekRTNWlBYnBlNDJKdyIsImtpZCI6IllUY2VPNUlKeXlxUjZqekRTNWlBYnBlNDJKdyJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zYWQwYjkwNS0zNGFiLTQxMTYtOTNkOS1jMWRjYzJkMzVhZjYvIiwiaWF0IjoxNzM3NjQ3OTAyLCJuYmYiOjE3Mzc2NDc5MDIsImV4cCI6MTczNzY1MTg0MiwiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhaQUFBQUVvenBBR0xNN2I4VXhSSDlFblJkRG5qRTBYeXZYdlBTOTZOUEh1RlIzQUovT0dYMzFlY0treVl4b1E2YWpuOVdkTTYvQTNTMVhJYVhBRDliS2RQT011K0R3eHp5R3JpeFgvNTFnL2t1L3N3PSIsImFtciI6WyJwd2QiLCJyc2EiLCJtZmEiXSwiYXBwaWQiOiIwNGIwNzc5NS04ZGRiLTQ2MWEtYmJlZS0wMmY5ZTFiZjdiNDYiLCJhcHBpZGFjciI6IjAiLCJkZXZpY2VpZCI6ImM2ZDc4MzRjLWM1M2EtNGQ1NS04Y2JmLTAzYjBjN2VlN2IyZiIsImZhbWlseV9uYW1lIjoiTWluZWxsYSIsImdpdmVuX25hbWUiOiJNYXVybyIsImdyb3VwcyI6WyI5ZDU2ZmY0ZS02MjkzLTQwYzUtODZmZC1lZjI4NWFlOWY1NjQiLCJjM2RhNDI5MS05YTE4LTQ0MjktYTVmOS05OWFiMWIwNTg3NTMiXSwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiOTMuNTYuMTA0LjI0OSIsIm5hbWUiOiJNYXVybyBNaW5lbGxhIiwib2lkIjoiNjhjNGJmMWUtN2M0OS00ZjkyLWE4ZjUtMGQzMzE4MzFjNTFhIiwicHVpZCI6IjEwMDMyMDAzQUFGQzk4QzkiLCJwd2RfdXJsIjoiaHR0cHM6Ly9wb3J0YWwubWljcm9zb2Z0b25saW5lLmNvbS9DaGFuZ2VQYXNzd29yZC5hc3B4IiwicmgiOiIxLkFiMEFCYm5RT3FzMEZrR1QyY0hjd3ROYTlrWklmM2tBdXRkUHVrUGF3ZmoyTUJNREFVSzlBQS4iLCJzY3AiOiJ1c2VyX2ltcGVyc29uYXRpb24iLCJzaWQiOiI0NzNmNTI1OS0xZjNjLTQ2NGMtOWZmYi1lNzM0ZmQ0ZDVhZjYiLCJzdWIiOiJvNzJ1LTJzREtZTUdqVW9pY2VRMnk4ejJXd3BpWWhtWXJoSmVjRmdFWUZZIiwidGlkIjoiM2FkMGI5MDUtMzRhYi00MTE2LTkzZDktYzFkY2MyZDM1YWY2IiwidW5pcXVlX25hbWUiOiJtYXVyby5taW5lbGxhQE1uZ0Vudk1DQVA4ODM2NTIub25taWNyb3NvZnQuY29tIiwidXBuIjoibWF1cm8ubWluZWxsYUBNbmdFbnZNQ0FQODgzNjUyLm9ubWljcm9zb2Z0LmNvbSIsInV0aSI6Im55d2lTWHFUVWstcE9TdTdEUjRZQUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjE1OGMwNDdhLWM5MDctNDU1Ni1iN2VmLTQ0NjU1MWE2YjVmNyIsIjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdLCJ4bXNfY2FlIjoiMSIsInhtc19jYyI6WyJDUDEiXSwieG1zX2ZpbHRlcl9pbmRleCI6WyIxODkiXSwieG1zX2lkcmVsIjoiMSA2IiwieG1zX3JkIjoiMC40MkxqWUJSaTJzc0lBQSIsInhtc19zc20iOiIxIiwieG1zX3RjZHQiOjE3MjE3NzY2MTh9.JJU1R7BNK6Jya_04IkF__1O-qcmdxHVMwVqYkWmEff5Q3SmqA9CiBMH8O1DXmoZkzAc0y7bBBSoZtnuEmzUt38gRwAcXMSOXY1NXYtfgqyNW5yX177_NUmOy5NdyqhcE5f5wxi2Xyf-05739P9tV7nDhkynE_Tl8jkFaOyv4rOtcMBDGcOyFISwX9LZNftTqMR8zVzldkuIb3Wsqk69c7UBimTv_oRpwaVywrZPp0Lo8AETr1NAvm1fHKKNyUQtyXU5HgpmVk1FKxgVIFpUBrbaMAiWxmOHmzBWVYmQZgj-s5U1c0l-UbgIIfwVJv_zJxseRt5_Rpy_iPja0gNLyHg

@subscription_id     = eca2eddb-0f0c-4351-a634-52751499eeea
@apim-name           = mauromiapim01

@resource-group-name = mmcognitivegrp

@apim-api-version    = 2023-09-01-preview

@backend-openai-main-name = backend-openai-main-mmopenaisec
@backend-openai-main-url  = https://mmoaiswc-01.openai.azure.com/openai

@backend-openai-fallback-name = backend-openai-fallback-mmopenaiscus
@backend-openai-fallback-url  = https://mmoaiscus-01.openai.azure.com/openai

@backend-openai-pool-name = backend-openai-pool



# Backend - Fallback (no restrictions)
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-fallback-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backend-openai-fallback-name}}",
    "description": "{{backend-openai-fallback-name}}",
    "url": "{{backend-openai-fallback-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    }
  }
}


###


# Backend - Main with Circuit Breaker
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-main-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "properties": {
    "title": "{{backend-openai-main-name}}",
    "description": "{{backend-openai-main-name}}",
    "url": "{{backend-openai-main-url}}",
    "protocol": "http",
    "tls": {
      "validateCertificateChain": true,
      "validateCertificateName": true
    },
    "circuitBreaker": {
      "rules": [
        {
          "name": "myBreakerRule",
          "tripDuration": "PT60S",
          "acceptRetryAfter": "false",
          "failureCondition": {
            "count": "1",
            "interval": "PT10S",
            "statusCodeRanges": [
              {
                "min": "429",
                "max": "429"
              }
            ]
          }
        }
      ]
    }
  }
}

###

# Backend Pool Creation or Update using PUT
PUT https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-pool-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "type": "Microsoft.ApiManagement/service/backends",
  "name": "{{backend-openai-pool-name}}",
  "properties": {
    "description": "{{backend-openai-pool-name}}",
    "type": "Pool",
    "pool": {
      "services": [
        {
          "id": "/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-main-name}}",
          "priority":1
        },
        {
          "id": "/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-fallback-name}}",
          "priority":2
        }
      ]
    }
  }
}

###

# Backend Retrieval using GET
@backendToRetrieve={{backend-openai-fallback-name}}
GET https://management.azure.com/subscriptions/{{subscription_id}}/resourceGroups/{{resource-group-name}}/providers/Microsoft.ApiManagement/service/{{apim-name}}/backends/{{backend-openai-fallback-name}}?api-version={{apim-api-version}}
Authorization: Bearer {{token}}

